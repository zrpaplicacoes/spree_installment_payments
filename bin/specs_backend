#!/bin/bash

# Uncomment if redis is required
# apt-get install -qq -y redis-server
# redis-server&

cat > ~/.gemrc <<-EOM
  install: --no-rdoc --no-ri
  update:  --no-rdoc --no-ri
EOM

bundle install --jobs $(nproc) --path /cache/gems

# Uncomment if sidekiq is required
# RAILS_ENV=ci bundle exec sidekiq &

bundle exec brakeman -zAq
rails db:environment:set RAILS_ENV=ci
RAILS_ENV=ci bundle exec rake db:create db:migrate
RAILS_ENV=ci AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID rspec .
